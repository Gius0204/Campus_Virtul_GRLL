@model dynamic
@{
    ViewData["Title"] = "Detalle del Curso";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
    object? cursoObj = ViewBag.Curso;
    bool cursoDisponible = cursoObj != null;
    bool puedeEditar = (bool)(ViewBag.PuedeEditar ?? false);
}
<div class="container-fluid">
    @if (!cursoDisponible)
    {
        <div class="alert alert-danger">No se encontró el curso.</div>
        <div class="mt-3">
            <a class="btn btn-secondary" href="@Url.Action("Index","Cursos")">Volver al Catálogo</a>
        </div>
    }
    else
    {
        var c = ((Guid id, string titulo, string? descripcion, string estado, DateTime creadoEn))cursoObj; // tuple fuertemente tipado
        <h1 class="page-title mb-2">@c.titulo</h1>
        <p class="text-muted">@c.descripcion</p>
        <p><strong>Estado:</strong> @c.estado</p>
        @if (TempData["Mensaje"] != null){<div class="alert alert-success">@TempData["Mensaje"]</div>}
        @if (TempData["Error"] != null){<div class="alert alert-danger">@TempData["Error"]</div>}

    <div class="mb-3">
        @if (User.IsInRole("Practicante"))
        {
            <form method="post" asp-action="SolicitarInscripcion" asp-controller="Cursos">
                @Html.AntiForgeryToken()
                <input type="hidden" name="idCurso" value="@c.id" />
                <button class="btn btn-primary">Solicitar Inscripción</button>
            </form>
        }
        @if (puedeEditar && (string)c.estado == "borrador")
        {
            <form method="post" asp-action="Publicar" asp-controller="Cursos" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="idCurso" value="@c.id" />
                <button class="btn btn-success">Publicar Curso</button>
            </form>
        }
        else if (puedeEditar && (string)c.estado == "publicado")
        {
            <form method="post" asp-action="Borrador" asp-controller="Cursos" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="idCurso" value="@c.id" />
                <button class="btn btn-warning">Marcar como Borrador</button>
            </form>
        }
    </div>

        <div class="content-card mb-4">
            <p><strong>Creado:</strong> @c.creadoEn.ToString("yyyy-MM-dd")</p>
            <hr />
            <h5>Profesores asignados</h5>
            @{ var asignados = (IEnumerable<(Guid profesorId, string nombres, string? apellidos, string? telefono, string correo, string? area)>)ViewBag.ProfesoresAsignados ?? Enumerable.Empty<(Guid, string, string?, string?, string, string?)>(); }
            @if (!asignados.Any())
            {
                <p class="text-muted">No hay profesores asignados.</p>
            }
            else
            {
                <table class="table table-sm">
                    <thead><tr><th>Nombres</th><th>Apellidos</th><th>Correo</th><th>Área</th><th>Acción</th></tr></thead>
                    <tbody>
                    @foreach (var p in asignados)
                    {
                        <tr>
                            <td>@p.nombres</td>
                            <td>@(p.apellidos ?? "-")</td>
                            <td>@p.correo</td>
                            <td>@(p.area ?? "-")</td>
                            <td>
                                @if (puedeEditar)
                                {
                                    <form method="post" asp-action="RetirarProfesor" asp-controller="Cursos" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="idCurso" value="@c.id" />
                                        <input type="hidden" name="profesorId" value="@p.profesorId" />
                                        <button class="btn btn-outline-danger btn-sm">Retirar</button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
            @if (puedeEditar)
            {
                <hr />
                <h5>Asignar nuevos profesores</h5>
                <input type="text" id="buscarProfesor" class="form-control form-control-sm mb-2" placeholder="Buscar profesor..." />
                var disponibles = (IEnumerable<(Guid id, string nombres, string correo)>)ViewBag.ProfesoresDisponibles ?? Enumerable.Empty<(Guid, string, string)>();
                @if (!disponibles.Any())
                {
                    <p class="text-muted">No hay profesores disponibles para asignar.</p>
                }
                else
                {
                    <table class="table table-sm" id="tablaDisponibles">
                        <thead><tr><th>Nombres</th><th>Correo</th><th>Acción</th></tr></thead>
                        <tbody>
                        @foreach (var p in disponibles)
                        {
                            <tr>
                                <td class="col-nombre">@p.nombres</td>
                                <td>@p.correo</td>
                                <td>
                                    <form method="post" asp-action="AsignarProfesor" asp-controller="Cursos" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="idCurso" value="@c.id" />
                                        <input type="hidden" name="profesorId" value="@p.id" />
                                        <button class="btn btn-outline-primary btn-sm">Asignar</button>
                                    </form>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
            }
        </div>

        <script>
            (function(){
                const input = document.getElementById('buscarProfesor');
                if(!input) return;
                input.addEventListener('keyup', function(){
                    const term = this.value.toLowerCase();
                    document.querySelectorAll('#tablaDisponibles tbody tr').forEach(tr => {
                        const nombre = tr.querySelector('.col-nombre')?.textContent?.toLowerCase() || '';
                        tr.style.display = nombre.includes(term) ? '' : 'none';
                    });
                });
            })();
        </script>

        <div class="mt-3">
            <a class="btn btn-secondary" href="@Url.Action("Index","Cursos")">Volver al Catálogo</a>
        </div>
    }
</div>