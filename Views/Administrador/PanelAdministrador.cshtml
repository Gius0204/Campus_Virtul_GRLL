@{
    ViewData["Title"] = "Panel Administrador";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<div class="container-fluid">
    <div class="row mb-4">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">Información del Usuario</div>
                    <div class="card-body">
                        <p><strong>Nombres:</strong> @(ViewBag.Nombres ?? User.Identity?.Name)</p>
                        <p><strong>Apellidos:</strong> @(ViewBag.Apellidos ?? "-")</p>
                        <p><strong>Rol:</strong> @User.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Role)?.Value</p>
                        <p><strong>Área:</strong> @(ViewBag.Area ?? "-")</p>
                        <p><strong>DNI:</strong> @(ViewBag.DNI ?? "-")</p>
                        <p><strong>Teléfono:</strong> @(ViewBag.Telefono ?? "-")</p>
                    </div>
                </div>
        </div>

        <div class="col-md-6">
            <div class="content-card">
                <h5>Gestión de Cursos</h5>
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <a href="@Url.Action("PanelAdministrador","Administrador", new { vista = "cursos" })" class="text-decoration-none">
                            <div class="stat-card text-center p-3 mb-3" style="background: #3498db; color: white; border-radius: 8px; cursor:pointer;">
                                <h3>@(ViewBag.TotalCursos ?? 0)</h3>
                                <p>Total Cursos</p>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="@Url.Action("PanelAdministrador","Administrador", new { vista = "profesores" })" class="text-decoration-none">
                            <div class="stat-card text-center p-3 mb-3" style="background: #2ecc71; color: white; border-radius: 8px; cursor:pointer;">
                                <h3>@(ViewBag.TotalProfesores ?? 0)</h3>
                                <p>Profesores</p>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="@Url.Action("PanelAdministrador","Administrador", new { vista = "practicantes" })" class="text-decoration-none">
                            <div class="stat-card text-center p-3 mb-3" style="background: #e74c3c; color: white; border-radius: 8px; cursor:pointer;">
                                <h3>@(ViewBag.TotalPracticantes ?? 0)</h3>
                                <p>Practicantes</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de cursos y creación -->
    <div class="row">
        <div class="col-12">
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Listado de registros </h5>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#crearCursoModal">
                        ➕ Nuevo Curso
                    </button>
                </div>
                <hr>
                <div class="table-responsive" id="lista-cursos">
                    @{
                        var vista = (string)(ViewBag.Vista ?? "cursos");
                    }
                    @if (vista == "cursos")
                    {
                        var cursos = (ViewBag.Cursos as IEnumerable<(Guid id, string titulo, string? descripcion, string estado, DateTime creadoEn)>) ?? Enumerable.Empty<(Guid id, string titulo, string? descripcion, string estado, DateTime creadoEn)>();
                        @if (!cursos.Any())
                        {
                            <div class="alert alert-info m-2">No hay cursos registrados aún.</div>
                        }
                        else
                        {
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Título</th>
                                        <th>Descripción</th>
                                        <th>Estado</th>
                                        <th>Profesores asignados</th>
                                        <th>Creado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var c in cursos)
                                    {
                                        <tr>
                                            <td>@c.titulo</td>
                                            <td>@(string.IsNullOrWhiteSpace(c.descripcion) ? "-" : c.descripcion)</td>
                                            <td>@c.estado</td>
                                            <td>
                                                @{ var asignados = (IEnumerable<(Guid profesorId, string nombres, string correo)>)ViewBag.ProfesoresAsignadosPorCurso?.Invoke(c.id) ?? Enumerable.Empty<(Guid profesorId, string nombres, string correo)>(); }
                                                @(asignados.Count())
                                            </td>
                                            <td>@c.creadoEn.ToString("yyyy-MM-dd")</td>
                                            <td>
                                                <a class="btn btn-sm btn-info" href="@Url.Action("Detalle","Cursos", new { id = c.id })">Ver</a>
                                                <form method="post" asp-action="@(c.estado == "publicado" ? "BorradorCurso" : "PublicarCurso")" asp-controller="Administrador" style="display:inline-block;">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@c.id" />
                                                    <button type="submit" class="btn btn-sm @(c.estado == "publicado" ? "btn-secondary" : "btn-success")">
                                                        @(c.estado == "publicado" ? "Borrador" : "Publicar")
                                                    </button>
                                                </form>
                                                <form method="post" asp-action="EliminarCurso" asp-controller="Administrador" style="display:inline-block;" onsubmit="return confirm('¿Eliminar curso?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@c.id" />
                                                    <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    }
                    else
                    {
                        var usuarios = (ViewBag.Usuarios as IEnumerable<(Guid id, string nombres, string correo, bool activo, Guid rolId, string rolNombre)>) ?? Enumerable.Empty<(Guid id, string nombres, string correo, bool activo, Guid rolId, string rolNombre)>();
                        @if (!usuarios.Any())
                        {
                            <div class="alert alert-info m-2">No hay usuarios en esta categoría.</div>
                        }
                        else
                        {
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombres</th>
                                        <th>Correo</th>
                                        <th>Rol</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var u in usuarios)
                                    {
                                        <tr>
                                            <td>@u.nombres</td>
                                            <td>@u.correo</td>
                                            <td>@u.rolNombre</td>
                                            <td>@(u.activo ? "Activo" : "Inactivo")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Curso -->
<div class="modal fade" id="crearCursoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="CrearCurso" asp-controller="Administrador" method="post" id="crearCursoForm">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" name="titulo" class="form-control" required maxlength="120" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea name="descripcion" class="form-control" rows="3" maxlength="500"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Estado inicial</label>
                        <select name="estado" class="form-select" required>
                            <option value="borrador" selected>Borrador</option>
                            <option value="publicado">Publicado</option>
                        </select>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Crear</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>

@section Scripts {
    <script>
        console.log('Panel de Administrador cargado correctamente');
    </script>
}

