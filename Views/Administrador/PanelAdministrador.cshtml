@{
    ViewData["Title"] = "Panel Administrador";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
}

<div class="container-fluid">
    <div class="row mb-4">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">Información del Usuario</div>
                    <div class="card-body">
                        <p><strong>Nombres:</strong> @(ViewBag.Nombres ?? User.Identity?.Name)</p>
                        <p><strong>Apellidos:</strong> @(ViewBag.Apellidos ?? "-")</p>
                        <p><strong>Rol:</strong> @User.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Role)?.Value</p>
                        <p><strong>Área:</strong> @(ViewBag.Area ?? "-")</p>
                        <p><strong>DNI:</strong> @(ViewBag.DNI ?? "-")</p>
                        <p><strong>Teléfono:</strong> @(ViewBag.Telefono ?? "-")</p>
                    </div>
                </div>
        </div>

        <div class="col-md-6">
            <div class="content-card">
                <h5>Gestión de Cursos</h5>
                <hr>
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 mb-3" style="background: #3498db; color: white; border-radius: 8px;">
                            <h3>@(ViewBag.TotalCursos ?? 0)</h3>
                            <p>Total Cursos</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 mb-3" style="background: #2ecc71; color: white; border-radius: 8px;">
                            <h3>@(ViewBag.TotalProfesores ?? 0)</h3>
                            <p>Profesores</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 mb-3" style="background: #e74c3c; color: white; border-radius: 8px;">
                            <h3>@(ViewBag.TotalPracticantes ?? 0)</h3>
                            <p>Practicantes</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3 mb-3" style="background: #f39c12; color: white; border-radius: 8px;">
                            <h3>@(ViewBag.TotalColaboradores ?? 0)</h3>
                            <p>Colaboradores</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selección de cursos publicados y gráfico de participantes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-card">
                <h5>Gráfico de participantes por curso</h5>
                <hr />
                @{ var cursosPubSection = (ViewBag.Cursos as IEnumerable<(Guid id, string titulo, string? descripcion, string estado, DateTime creadoEn)>) ?? Enumerable.Empty<(Guid, string, string?, string, DateTime)>(); }
                <div class="mb-3">
                    <label class="form-label">Seleccione cursos publicados</label>
                    <div class="dropdown w-100">
                        <button class="form-control text-start dropdown-toggle" type="button" id="comboCursosBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="comboSelectedText">Seleccione cursos…</span>
                        </button>
                        <div class="dropdown-menu p-2 w-100" aria-labelledby="comboCursosBtn" style="max-height: 340px; overflow-y: auto;">
                            <div class="mb-2 d-flex">
                                <input type="text" class="form-control form-control-sm" id="comboSearch" placeholder="Buscar curso..." />
                            </div>
                            <div class="d-flex mb-2">
                                <button class="btn btn-sm btn-outline-primary me-2" id="btnSelectAll">Seleccionar todo</button>
                                <button class="btn btn-sm btn-outline-secondary" id="btnClearAll">Deseleccionar todo</button>
                            </div>
                            <div id="cursosFilter" class="list-group">
                                @foreach (var c in cursosPubSection.Where(x => string.Equals(x.estado, "publicado", StringComparison.OrdinalIgnoreCase)))
                                {
                                    <label class="list-group-item d-flex align-items-center">
                                        <input class="form-check-input me-2 curso-check" type="checkbox" value="@c.id">
                                        <span class="curso-title">@c.titulo</span>
                                    </label>
                                }
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">Use el buscador para filtrar y seleccione los cursos a visualizar.</small>
                </div>
                <button id="btnVerGraficosAdmin" class="btn btn-primary">Ver gráficos</button>
                <div id="chartsGrid" class="charts-grid" style="display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:16px; margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <!-- Se elimina la sección de Listado de Registros del dashboard -->
</div>

@* Se elimina el modal de creación de curso del dashboard *@

@section Scripts {
    <script>
        console.log('Panel de Administrador cargado correctamente');
        // Cargar Chart.js si no está
        (function ensureChartJs(){
            if (!window.Chart){
                var s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                document.head.appendChild(s);
            }
        })();

        // Toast estilo app
        function showAppToast(message, type){
            var toastEl = document.getElementById('appToast');
            var bodyEl = document.getElementById('appToastBody');
            if (!toastEl || !bodyEl) { alert(message); return; }
            bodyEl.textContent = message;
            toastEl.classList.remove('text-bg-success','text-bg-danger','text-bg-warning','text-bg-info');
            var cls = 'text-bg-warning';
            if (type === 'success') cls = 'text-bg-success';
            if (type === 'danger') cls = 'text-bg-danger';
            if (type === 'info') cls = 'text-bg-info';
            toastEl.classList.add(cls);
            var toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        }

        // Helpers
        function getSelectedIds(){
            return Array.from(document.querySelectorAll('.curso-check:checked')).map(i => i.value);
        }

        function updateComboSelectedText(){
            var selected = Array.from(document.querySelectorAll('.curso-check:checked')).map(i => i.closest('label').querySelector('.curso-title').textContent.trim());
            var textEl = document.getElementById('comboSelectedText');
            if (!textEl) return;
            if (selected.length === 0) { textEl.textContent = 'Seleccione cursos…'; return; }
            if (selected.length <= 3) { textEl.textContent = selected.join(', '); return; }
            textEl.textContent = selected.length + ' seleccionados';
        }

        async function renderCharts(ids){
            var grid = document.getElementById('chartsGrid');
            if (!grid) return;
            grid.innerHTML = '';
            if (window._chartsAdmin && Array.isArray(window._chartsAdmin)){
                window._chartsAdmin.forEach(c => { try { c.destroy(); } catch {} });
            }
            window._chartsAdmin = [];
            if (!ids || ids.length === 0){ showAppToast('Seleccione al menos un curso publicado', 'warning'); return; }
            try{
                const params = ids.map(id => 'ids=' + encodeURIComponent(id)).join('&');
                const resp = await fetch('@Url.Action("ParticipanteCounts","Administrador")' + '?' + params);
                const json = await resp.json();
                if (!json.ok){ showAppToast(json.error || 'Ocurrió un error al cargar los datos', 'danger'); return; }
                // Crear un gráfico por curso seleccionado
                json.data.forEach(function(d){
                    var card = document.createElement('div');
                    card.className = 'card';
                    var header = document.createElement('div');
                    header.className = 'card-header';
                    header.textContent = d.titulo;
                    var body = document.createElement('div');
                    body.className = 'card-body';
                    var canvas = document.createElement('canvas');
                    body.appendChild(canvas);
                    card.appendChild(header);
                    card.appendChild(body);
                    grid.appendChild(card);

                    var chart = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: ['Profesores', 'Practicantes', 'Colaboradores'],
                            datasets: [{
                                label: 'Participantes',
                                data: [d.profesores, d.practicantes, d.colaboradores],
                                backgroundColor: ['#2ecc71', '#e74c3c', '#f39c12'] // Verde, Rojo, Naranja
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: { y: { beginAtZero: true, precision: 0 } },
                            plugins: { legend: { display: false } }
                        }
                    });
                    window._chartsAdmin.push(chart);
                });
            }catch(e){ alert('Error: ' + e); }
        }

        // Botón para renderizar gráficos según selección
        document.getElementById('btnVerGraficosAdmin')?.addEventListener('click', function(){
            var ids = getSelectedIds();
            renderCharts(ids);
        });

        // Seleccionar/Deseleccionar todo
        document.getElementById('btnSelectAll')?.addEventListener('click', function(e){
            e.preventDefault();
            document.querySelectorAll('.curso-check').forEach(i => i.checked = true);
            updateComboSelectedText();
        });
        document.getElementById('btnClearAll')?.addEventListener('click', function(e){
            e.preventDefault();
            document.querySelectorAll('.curso-check').forEach(i => i.checked = false);
            updateComboSelectedText();
        });

        // Al cargar, seleccionar hasta 5 cursos publicados y renderizar
        document.addEventListener('DOMContentLoaded', function(){
            var checks = Array.from(document.querySelectorAll('.curso-check'));
            checks.slice(0, 5).forEach(i => i.checked = true);
            var ids = getSelectedIds();
            updateComboSelectedText();
            if (ids.length > 0) renderCharts(ids);
            // Filtrado por buscador
            var search = document.getElementById('comboSearch');
            if (search){
                search.addEventListener('input', function(){
                    var q = this.value.toLowerCase();
                    document.querySelectorAll('#cursosFilter .list-group-item').forEach(function(lbl){
                        var t = (lbl.querySelector('.curso-title')?.textContent || '').toLowerCase();
                        lbl.style.display = t.indexOf(q) >= 0 ? '' : 'none';
                    });
                });
            }
            // Actualizar texto al seleccionar/deseleccionar
            document.querySelectorAll('.curso-check').forEach(function(ch){
                ch.addEventListener('change', updateComboSelectedText);
            });
        });
    </script>
}

