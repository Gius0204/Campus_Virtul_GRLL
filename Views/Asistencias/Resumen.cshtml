@{
    ViewData["Title"] = "Resumen de Asistencias";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
    var r = ((int presente, int tardanza, int ausente, int justificado))ViewBag.Resumen;
}

<div class="content-card">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h5 class="mb-0">Resumen de Asistencias</h5>
            <p class="text-muted mb-0">Totales del curso seleccionado</p>
        </div>
        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Regresar</button>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">Conteos</h6>
                    <div style="max-width:600px">
                        <canvas id="chartBar"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title">Porcentajes</h6>
                    <div class="d-flex align-items-center">
                        <div style="max-width:300px" class="me-3">
                            <canvas id="chartPie"></canvas>
                        </div>
                        <div>
                            <ul class="list-unstyled small mb-0" id="pieLegend"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
@* Quitar plugin externo para evitar incompatibilidades *@
<script>
const labels = ['Presente','Tardanza','Ausente','Justificado'];
const bg = ['#2ecc71','#f1c40f','#e74c3c','#3498db'];
const counts = [@r.presente, @r.tardanza, @r.ausente, @r.justificado];
const total = counts.reduce((a,b)=>a+b,0);

new Chart(document.getElementById('chartBar'), {
    type: 'bar',
    data: {
        labels,
        datasets: [{ label: 'Asistencias', backgroundColor: bg, data: counts }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } }
    }
});

const chartPie = new Chart(document.getElementById('chartPie'), {
    type: 'doughnut',
    data: {
        labels,
        datasets: [{ data: counts, backgroundColor: bg }]
    },
    options: {
        cutout: '60%',
        plugins: { legend: { display: false } }
    },
    plugins: [{
        // Center total text plugin
        id: 'centerText',
        afterDraw(chart) {
            const { ctx, chartArea } = chart;
            const x = (chartArea.left + chartArea.right) / 2;
            const y = (chartArea.top + chartArea.bottom) / 2;
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px system-ui, -apple-system, Segoe UI, Roboto';
            ctx.fillText('Total', x, y - 12);
            ctx.font = 'bold 22px system-ui, -apple-system, Segoe UI, Roboto';
            ctx.fillText(total.toString(), x, y + 10);
            ctx.restore();
        }
    },{
        // Segment percentage labels without external plugin
        id: 'segmentLabels',
        afterDatasetsDraw(chart) {
            const { ctx } = chart;
            const meta = chart.getDatasetMeta(0);
            const dataset = chart.data.datasets[0];
            if (!meta || !dataset) return;
            ctx.save();
            ctx.fillStyle = '#333';
            ctx.font = 'bold 12px system-ui, -apple-system, Segoe UI, Roboto';
            meta.data.forEach((arc, i) => {
                const value = dataset.data[i];
                if (!value || total === 0) return;
                const pct = ((value / total) * 100).toFixed(1) + '%';
                // Compute the text position roughly at 75% of radius on the bisector
                const { x, y } = arc.getProps(['x','y'], true);
                const radius = arc.outerRadius - (arc.outerRadius - arc.innerRadius) / 2;
                const startAngle = arc.startAngle;
                const endAngle = arc.endAngle;
                const angle = (startAngle + endAngle) / 2;
                const tx = x + Math.cos(angle) * radius * 0.85;
                const ty = y + Math.sin(angle) * radius * 0.85;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(pct, tx, ty);
            });
            ctx.restore();
        }
    }]
});

// Build legend with counts and percentages
const legend = document.getElementById('pieLegend');
legend.innerHTML = labels.map((l, i) => {
    const pct = total ? ((counts[i] / total) * 100).toFixed(1) : '0.0';
    return `<li class="mb-1"><span style="display:inline-block;width:10px;height:10px;background:${bg[i]};border-radius:50%;margin-right:8px"></span>${l}: <strong>${counts[i]}</strong> (${pct}%)`;
}).join('');
</script>
